kind: pipeline
name: Memos Build
node:
  region: cn
  
trigger:
  branch:
    include:
      - main

platform:
  matrix:
    include:
      - os: linux
        arch: amd64
      - os: linux
        arch: arm64
      - os: windows
        arch: amd64
      - os: darwin
        arch: amd64

steps:
  - name: Checkout repository
    image: alpine/git
    settings:
      depth: 1
    commands:
      - git clone https://github.com/usememos/memos.git

  - name: Setup Node.js
    image: node:18.12.1
    commands:
      - cd memos/web
      - npm install -g pnpm
      - pnpm i --frozen-lockfile
      - pnpm build
      - ls -alh 
      - ls ../
      - cp -rf dist ../server/

  - name: Setup Go
    image: golang:1.19.3
    environment:
      DRONE_ARCH: "{{ arch }}"
      DRONE_SYSTEM_EXT: ""
    commands:
      - cd memos
      - go build -o memos-${DRONE_ARCH}${DRONE_SYSTEM_EXT} ./main.go

  - name: Upload artifacts
    image: plugins/s3
    settings:
      bucket: my-bucket-name
      source: memos/memos-${DRONE_ARCH}${DRONE_SYSTEM_EXT}
      target: latest/memos-${DRONE_ARCH}${DRONE_SYSTEM_EXT}
